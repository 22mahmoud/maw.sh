{# djlint:off D018 #}
{% extends "base.html" %}
{% load base_tags wagtail_cache link_tags wagtailcore_tags wagtailimages_tags %}
{% load comments_xtd comments %}

{% block head %}
  <link rel="dns-prefetch" href="//gravatar.com">
{% endblock head %}

{% block aside %}
  {% with toc=page.toc %}
    {% if toc %}
      <details class="py-2 px-4">
        <summary class="cursor-pointer text-accent font-semibold text-base hover:underline">
          Table of Contents
        </summary>
        <nav aria-label="Table of contents">
          <ul class="flex flex-col gap-y-2 mt-4">
            {% for heading in toc %}
              <li style="padding-left: {{ heading.depth|add:'-2'|add:'1'|mul:12 }}px;">
                <a href="#{{ heading.slug }}"
                   class="block transition-colors duration-200 text-primary/90 hover:text-accent hover:underline">
                  {{ heading.text }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </nav>
      </details>
    {% endif %}
  {% endwith %}
{% endblock aside %}

{% block content %}
  <div class="zigzag bg-dark pt-6">
    <article class="h-entry flex flex-col mx-auto max-w-3xl gap-8 py-6 px-4 sm:px-6">
      {% wagtailpagecache 500 post_page_header %}
        {% include "includes/breadcrumb.html" with page=self %}
        <header class="px-4 bg-darker flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 text-sm py-4 border-b border-primary/20">
          <div class="flex items-center flex-wrap gap-3 sm:gap-4 flex-1 min-w-0">
            {% for author in page.authors %}
              <a href="{{ author.get_full_url }}"
                 class="h-card flex items-center gap-3 transition-all duration-200 hover:scale-[1.02] group">
                <div class="w-10 ht-10 sm:w-12 sm:ht-12 rounded-full overflow-hidden flex-shrink-0 ring-2 ring-transparent group-hover:ring-accent/30 transition-all duration-200">
                  {% picture author.image format-{avif,webp,jpeg} width-200 alt=author.full_name class="u-photo w-full ht-100% object-cover" %}
                </div>
                <div class="flex flex-col min-w-0 flex-1">
                  <span class="p-name font-medium text-primary group-hover:text-accent transition-colors duration-200 truncate">
                    {{ author.full_name }}
                  </span>
                  {% if author.title %}
                    <span class="text-xs text-primary/80 truncate">{{ author.title }}</span>
                  {% endif %}
                  {% if author.bio %}
                    <span class="text-xs text-secondary truncate hidden sm:block"
                          title="{{ author.bio }}">
                      {{ author.bio|truncatewords:5 }}
                    </span>
                  {% endif %}
                </div>
              </a>
            {% endfor %}
          </div>
        {% endwagtailpagecache %}

        <div class="flex flex-col items-start sm:items-end text-left sm:text-right flex-shrink-0">
          <time class="dt-published font-medium text-primary text-sm sm:text-base"
                datetime="{{ page.first_published_at|date:'c' }}">
            <span class="hidden sm:inline">{{ page.first_published_at|date:"F j, Y" }}</span>
            <span class="sm:hidden">{{ page.first_published_at|date:"M j, Y" }}</span>
          </time>
          <span class="text-xs text-primary/70">
            {{ page.first_published_at|date:"g:i A" }}
          </span>
          {% if page.last_published_at != page.first_published_at %}
            <span class="text-xs text-primary/60 mt-1">
              <span class="hidden sm:inline">Updated</span>
              <span class="sm:hidden">Upd.</span>
              {{ page.last_published_at|date:"M j, Y" }}
            </span>
          {% endif %}
          {% if page.get_tags %}
            <div class="flex items-center flex-wrap gap-2 mt-2 sm:justify-end">
              <ul class="flex flex-wrap gap-2">
                {% for tag in page.get_tags %}
                  <li>
                    {% link href=tag.url variant="tag" %}
                      #{{ tag }}
                    {% endlink %}
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        </div>
      </header>

      <main class="flex-1 mt-6 sm:mt-8 space-y-12">
        <div class="relative">

          {% if page.body.0.block_type == 'article' %}
            <header class="mb-10 prose prose-main prose-headings:font-heading prose-headings:text-primary text-center space-y-3 sm:space-y-5">
              <h1 class="p-name text-balance font-heading">
                {{ page.title }}
              </h1>
              {% if page.subtitle %}
                <p class="text-base sm:text-lg md:text-xl text-secondary leading-relaxed max-w-4xl mx-auto">
                  {{ page.subtitle }}
                </p>
              {% endif %}
            </header>
          {% endif %}

          {% if page.body %}
            {% for block in page.body %}
              {% include_block block with layout="default" %}
            {% endfor %}
          {% endif %}

        </div>

        <div id="comments-section"
             class="pt-8 mt-12 border-t border-primary/20 space-y-8">

          {% get_comment_count for page as comment_count %}

          <div id="comments-count"
               hx-swap-oob="true"
               class="text-center text-sm text-secondary">
            {{ comment_count }} comment{{ comment_count|pluralize }} ha{{ comment_count|pluralize:"s,ve" }} been posted.
          </div>

          {% if comment_count %}
            <h2 class="text-2xl sm:text-3xl font-heading font-bold text-primary">
              Comments
            </h2>
          {% endif %}

          <section id="comment-confirmation" hx-swap-oob="true">
          </section>

          <section class="py-6 max-w-2xl">
            <h2 class="text-xl font-semibold mb-1">
              Post your comment
            </h2>

            {% if not request.user.is_authenticated %}
              <p class="text-sm text-stuble mb-4">
                You can
                <a href="{% url 'account_login' %}?next={{ request.get_full_path|urlencode }}"
                   class="text-accent underline hover:text-accent-bright">log in</a> or comment as a visitor.
              </p>
            {% else %}
              <p class="text-sm text-stuble mb-4">
                You're logged in as <span class="font-medium">{{ request.user.get_full_name|default:request.user.username }}</span>.
              </p>
            {% endif %}

            <section id="comment-form-wrapper" hx-swap-oob="true">
              <section id="comment-preview"
                       hx-swap-oob="true"
                       aria-live="polite"
                       aria-atomic="true">
              </section>
              {% render_comment_form for page %}
            </section>
          </section>

          <section hx-swap-oob="true" id="comments" class="space-y-6">
            {% if comment_count %}
              {% render_xtdcomment_tree for page show_feedback allow_feedback allow_flagging %}
            {% endif %}
          </section>
        </div>

        {% with webmentions=page.get_webmentions %}
          {% if webmentions %}
            <section class="mt-16 pt-12 border-t border-primary/20 space-y-10">
              <h2 class="text-2xl sm:text-3xl font-heading font-bold text-primary">
                Webmentions
              </h2>

              {% if webmentions.likes %}
                <div class="space-y-4">
                  <h3 class="text-lg font-medium text-primary">
                    Likes <span class="text-base text-secondary font-normal">({{ webmentions.likes|length }})</span>
                  </h3>
                  <div class="flex flex-wrap gap-2">
                    {% for mention in webmentions.likes %}
                      <a href="{{ mention.author.url }}"
                         title="{{ mention.author.name }}"
                         class="group block w-10 ht-10 rounded-full overflow-hidden transition-all duration-200 hover:scale-110">
                        <div class="w-full ht-100% ring-2 ring-transparent group-hover:ring-accent/70 rounded-full transition-all duration-200">
                          {% if mention.author.photo %}
                            {% picture mention.author.photo format-{avif,webp,jpeg} width-40 lading="lazy" class="w-full ht-100% object-cover" %}
                          {% else %}
                            <div class="flex items-center justify-center w-full ht-100% bg-neutral-700 text-primary font-bold text-lg">
                              ?
                            </div>
                          {% endif %}
                        </div>
                      </a>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}

              {% if webmentions.reposts %}
                <div class="space-y-4">
                  <h3 class="text-lg font-medium text-primary">
                    Reposts <span class="text-base text-secondary font-normal">({{ webmentions.reposts|length }})</span>
                  </h3>
                  <div class="flex flex-wrap gap-2">
                    {% for mention in webmentions.reposts %}
                      <a href="{{ mention.author.url }}"
                         title="{{ mention.author.name }}"
                         class="group block w-10 ht-10 rounded-full overflow-hidden transition-all duration-200 hover:scale-110">
                        <div class="w-full ht-100% ring-2 ring-transparent group-hover:ring-accent/70 rounded-full transition-all duration-200">
                          {% if mention.author.photo %}
                            {% picture mention.author.photo format-{avif,webp,jpeg} width-40 lading="lazy" class="w-full ht-100% object-cover" %}
                          {% else %}
                            <div class="flex items-center justify-center w-full ht-100% bg-neutral-700 text-primary font-bold text-lg">
                              ?
                            </div>
                          {% endif %}
                        </div>
                      </a>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}

              {% if webmentions.bookmarks %}
                <div class="space-y-4">
                  <h3 class="text-lg font-medium text-primary">
                    Bookmarks <span class="text-base text-secondary font-normal">({{ webmentions.bookmarks|length }})</span>
                  </h3>
                  <div class="flex flex-wrap gap-2">
                    {% for mention in webmentions.bookmarks %}
                      <a href="{{ mention.author.url }}"
                         title="{{ mention.author.name }}"
                         class="group block w-10 ht-10 rounded-full overflow-hidden transition-all duration-200 hover:scale-110">
                        <div class="w-full ht-100% ring-2 ring-transparent group-hover:ring-accent/70 rounded-full transition-all duration-200">
                          {% if mention.author.photo %}
                            {% picture mention.author.photo format-{avif,webp,jpeg} width-40 lading="lazy" class="w-full ht-100% object-cover" %}
                          {% else %}
                            <div class="flex items-center justify-center w-full ht-100% bg-neutral-700 text-primary font-bold text-lg">
                              ?
                            </div>
                          {% endif %}
                        </div>
                      </a>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}

              {% if webmentions.replies %}
                <div class="space-y-4">
                  <h3 class="text-lg font-medium text-primary">
                    Replies <span class="text-base text-secondary font-normal">({{ webmentions.replies|length }})</span>
                  </h3>
                  <div class="flex flex-col gap-6">
                    {% for mention in webmentions.replies %}
                      <div class="flex gap-3 sm:gap-4">
                        <div class="flex-shrink-0">
                          <a href="{{ mention.author.url }}"
                             class="group block w-10 ht-10 rounded-full overflow-hidden">
                            <div class="w-full ht-100% rounded-full ring-2 ring-transparent group-hover:ring-accent/70 transition-all duration-200">
                              {% if mention.author.photo %}
                                {% picture mention.author.photo format-{avif,webp,jpeg} width-40 lading="lazy" class="w-full ht-100% object-cover" %}
                              {% else %}
                                <div class="flex items-center justify-center w-full ht-100% bg-neutral-700 text-primary font-bold text-lg">
                                  ?
                                </div>
                              {% endif %}
                            </div>
                          </a>
                        </div>
                        <div class="flex-1 bg-darker p-3 sm:p-4 rounded-lg border border-primary/10">
                          <div class="flex justify-between items-center text-sm mb-2">
                            <a href="{{ mention.author.url }}"
                               class="font-medium text-primary hover:text-accent transition-colors duration-200">
                              {{ mention.author.name }}
                            </a>
                            <a href="{{ mention.url }}"
                               class="text-xs text-secondary hover:underline"
                               title="View original reply">
                              <time datetime="{{ mention.published|date:'c' }}">{{ mention.published|date:"M j, Y" }}</time>
                            </a>
                          </div>
                          <div class="prose prose-main prose-sm max-w-none text-primary/90 break-words sm:break-normal break-all">
                            {{ mention.content_html|safe }}
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            </section>
          {% endif %}
        {% endwith %}
      </main>

      <footer class="bg-darker [&_a]:border-1! [&_a]:w-fit mt-8 border-t border-primary/20 p-4">
        {% with next_sibling=page.next_sibling prev_sibling=page.prev_sibling %}
          {% include "includes/pagination.html" with
          prev_url=prev_sibling.url
          prev_title=prev_sibling.title|truncatewords:5
          next_url=next_sibling.url
          next_title=next_sibling.title|truncatewords:5
          %}
        {% endwith %}
      </footer>
    </article>
  </div>
{% endblock content %}
