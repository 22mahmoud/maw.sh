{% load base_tags button_tags %}

{{ guestbook_editor_presets|json_script:"guestbook-editor-presets" }}

<div x-data="guestbookEditor" class="w-full">
  <div class="space-y-6 max-w-xl mx-auto"
       hx-disabled-elt="#guestbook-submit-button"
       hx-indicator="#spinner">

    {% include "includes/guestbook_form.html" with form=form %}

    <div class="-mx-4 z-30 sticky top-0 bottom-0 md:static bg-darker/70 backdrop-blur-xs md:backdrop-blur-none border-t border-neutral-700 ht-full md:ht-auto flex flex-col gap-4 px-4 py-4 pb-6 md:pt-0 md:pb-10">
      <noscript>
        <div class="bg-darker mx-auto mt-6 p-4 text-sm text-neutral-400 border border-neutral-700 rounded">
          JavaScript is disabled. card preview is unavailable, but you can still submit the guestbook form.
        </div>
      </noscript>

      {% with guestbook_editor_presets.0 as default %}
        <button @click="togglePreviewVisibility"
                :aria-expanded="isPreviewVisible"
                aria-controls="guestbook-preview"
                class="js-only text-sm font-medium text-secondary mt-4 flex justify-between items-center w-full text-left focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-accent transition">
          <span>Live Preview</span>
          <span :class="previewToggleIconClass"
                class="transition-transform duration-300">
            {% icon "caret-up" class="w-5 ht-5" %}
          </span>
        </button>
        <div x-show="isPreviewVisible"
             x-collapse
             id="guestbook-preview"
             class="js-only prose prose-main min-h-50 flex flex-col relative p-6 transition-all shadow-xl border border-neutral-700 {{ default.get_style_classes }}"
             :class="previewCardClasses"
             role="region"
             aria-label="Preview card">
          <div class="text-3xl" x-text="form.emoji">
            {{ default.emoji }}
          </div>

          <div class="bg-transparent flex-1 mt-3 break-words"
               x-html="renderedMessage">
            Your message will appear here
          </div>

          <p class="self-end text-sm mt-2">
            <template x-if="canShowNameWithUrl">
              <a :href="form.url"
                 class="inline-flex items-center gap-1 underline"
                 target="_blank"
                 rel="noopener noreferrer">
                â€” <span x-text="form.name"></span>
                {% icon 'arrow-square-out' class="w-3 ht-3" %}
              </a>
            </template>
            <template x-if="canShowNameOnly">
              <span x-text="formattedName"></span>
            </template>
          </p>
        </div>
      {% endwith %}

      {% button
        form="guestbook-form"
        size="md"
        type="submit"
        class="w-fit rounded-none"
        id="guestbook-submit-button"
        %}
        <span>Submit</span>
        {% icon 'circle-notch' id="spinner" class="htmx-indicator animate-spin ht-5 w-5" %}
      {% endbutton %}
    </div>

  </div>
</div>
