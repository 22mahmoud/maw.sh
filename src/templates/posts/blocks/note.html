{% load wagtailimages_tags wagtailcore_tags %}

<div class="flex flex-col">
  {% if self.content_data.truncated and not is_feed %}
    <div class="p-summary sr-only">
      {{ self.content_data.truncated|striptags }}
    </div>
  {% endif %}

  <div class="e-content prose prose-main prose-sm sm:prose-base lg:prose-lg max-w-none">
    {{ self.content }}
  </div>

  {% if self.media %}
    {% with self.media|length as count %}
      <div class="mt-4 grid gap-3 sm:gap-4
                  {% if count == 1 %}
                    grid-cols-1
                  {% elif count == 2 or count == 3 %}
                    grid-cols-1 sm:grid-cols-2
                  {% else %}
                    grid-cols-1 sm:grid-cols-2 lg:grid-cols-2
                  {% endif %}">

        {% for block in self.media %}
          <div class="group relative overflow-hidden border border-primary/10 shadow-sm hover:shadow-xl transition-all duration-300 ease-in-out
                      {% if count == 1 %}
                        aspect-video
                      {% else %}
                        aspect-square
                      {% endif %}">
            <div class="w-full ht-full">
              {% if block.block_type == 'image' %}
                {% image block.value original as full %}
                <a href="{{ full.full_url }}"
                   class="block w-full ht-full"
                   aria-label="View full-size image"
                   target="_blank"
                   rel="noopener noreferrer">

                  {% if ".gif" in block.value.file.url|lower|slice:"-4:" %}
                    {% picture block.value format-{webp,gif} width-800 class="u-photo w-full ht-full object-cover group-hover:scale-105 transition-transform duration-300 ease-in-out" %}
                  {% else %}
                    {% picture block.value format-{avif,webp,jpeg} width-800 class="u-photo w-full ht-full object-cover group-hover:scale-105 transition-transform duration-300 ease-in-out" %}
                  {% endif %}
                </a>
              {% elif block.block_type == 'video' %}
                <div class="u-video w-full ht-full">
                  <div class="[&_video]:w-full [&_video]:ht-full [&_video]:object-cover [&_video]:group-hover:scale-105 [&_video]:transition-transform [&_video]:duration-300 [&_video]:ease-in-out">
                    {{ block }}
                  </div>
                </div>
              {% elif block.block_type == 'video_embed' %}
                <div class="w-full ht-full u-video [&_iframe,div]:w-full [&_iframe,&_div]:ht-full [&_iframe]:object-cover [&_iframe]:group-hover:scale-105 [&_iframe]:transition-transform [&_iframe]:duration-300 [&_iframe]:ease-in-out">
                  {{ block }}
                </div>
              {% elif block.block_type == 'codeblock' %}
                <div class="w-full ht-full bg-gray-900 text-white [&_pre]:p-4 [&_pre]:overflow-auto [&_pre]:w-full [&_pre]:ht-full">
                  {{ block }}
                </div>
              {% else %}
                <div class="p-4">
                  {{ block }}
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endwith %}
  {% endif %}
</div>
