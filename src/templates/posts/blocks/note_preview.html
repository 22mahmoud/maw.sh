{% load base_tags wagtailimages_tags wagtailcore_tags %}

<div class="flex flex-col gap-2">
  <div class="prose prose-main prose-sm md:prose-base p-summary {% if value.content_data.is_truncated %} [&>p:last-of-type]:inline [&>p:last-of-type]:mr-1
  {% endif %}
  ">
  {{ value.content_data.truncated|richtext }}

  {% if value.content_data.is_truncated %}
    <a href="{% pageurl post %}"
       class="inline text-accent hover:text-accent-bright underline hover:no-underline focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 transition-colors duration-200">
      See more
    </a>
  {% endif %}
</div>

{% if value.media %}
  {% with value.media|length as count %}
    <div class="mt-2 grid gap-2 sm:gap-3
                {% if count == 1 %}
                  grid-cols-1
                {% elif count == 2 or count == 3 %}
                  grid-cols-1 sm:grid-cols-2
                {% else %}
                  grid-cols-1 sm:grid-cols-2 lg:grid-cols-2
                {% endif %}">

      {% for block in value.media %}
        <div class="group relative overflow-hidden border border-primary/10 shadow-sm hover:shadow-lg transition-all duration-300 ease-in-out
                    {% if count == 1 %}
                      aspect-video
                    {% else %}
                      aspect-square
                    {% endif %}">

          <div class="w-full ht-100%">
            {% if block.block_type == 'image' %}
              {% if ".gif" in block.value.file.url|lower|slice:"-4:" %}
                {% picture block.value format-{webp,gif} width-800 class="u-photo w-full ht-100% object-cover group-hover:scale-105 transition-transform duration-300" %}
              {% else %}
                {% picture block.value format-{avif,webp,jpeg} width-800 class="u-photo w-full ht-100% object-cover group-hover:scale-105 transition-transform duration-300" %}
              {% endif %}
            {% elif block.block_type == 'video' %}
              <div class="u-video w-full ht-100%">
                <div class="[&_video]:w-full [&_video]:ht-100% [&_video]:object-cover [&_video]:group-hover:scale-105 [&_video]:transition-transform [&_video]:duration-300">
                  {{ block }}
                </div>
              </div>

            {% elif block.block_type == 'video_embed' %}
              <div class="w-full ht-100% u-video [&_iframe,div]:w-full [&_iframe,&_div]:ht-100% [&_iframe]:object-cover [&_iframe]:group-hover:scale-105 [&_iframe]:transition-transform [&_iframe]:duration-300 [&_iframe]:ease-in-out">
                {{ block }}
              </div>
            {% elif block.block_type == 'codeblock' %}
              <div class="w-full ht-100% bg-gray-900 text-white [&_pre]:p-4 [&_pre]:overflow-auto [&_pre]:w-full [&_pre]:ht-100%">
                {{ block }}
              </div>
            {% else %}
              {{ block }}
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% endwith %}
{% endif %}
</div>
