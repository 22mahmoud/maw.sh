#!/bin/sh

src="src"
dist=dist
atom_file="$dist"/rss.xml
stylesheet="/rss-style.xsl"

main() {
  echo "<?xml version='1.0' encoding='UTF-8' ?>"
  echo "<?xml-stylesheet type='text/xsl' href='$stylesheet'?>"
  echo "<feed xmlns='http://www.w3.org/2005/Atom'>"
  echo "<title>Mahmoud Ashraf</title>"
  echo "<subtitle>Mahmoud Ashraf is a Front-end developer based in Alexandria, Egypt.</subtitle>"
  echo "<link href='https://maw.sh/rss.xml' rel='self'/>"
  echo "<link href='https://maw.sh/'/>"
  echo "<updated>$(date -u +"%Y-%m-%dT%H:%M:%SZ")</updated>"
  echo "<id>https://maw.sh/</id>"
  echo "<author><name>Mahmoud Ashraf</name></author>"

  blogs=$(mktemp)
  find "$src"/blog -type f -name index.md ! -path "$src/blog/index.md" -print |
    while read -r file; do
      is_draft="$(yq --front-matter="extract" '.draft' "$file")"
      if [ "$is_draft" = 'true' ]; then
        continue
      fi

      slug="$(basename "$(dirname "$file")")"
      title="$(yq --front-matter="extract" '.title-prefix' "$file")"
      description="$(yq --front-matter="extract" '.description' "$file")"
      date="$(yq --front-matter="extract" '.date' "$file")"

      echo "$date|$title|$description|$slug|$file" >>"$blogs"
    done

  sort -t '|' -k1,1r "$blogs" | while IFS='|' read -r date title description slug file; do
    temp_file=$(mktemp)
    formatted_date="$(date -u -d "$date" +"%Y-%m-%dT%H:%M:%SZ")"
    pandoc \
      --variable no-metadata=true \
      --lua-filter filters/img_filter.lua \
      --filter filters/shiki.js \
      --lua-filter filters/include-code-files.lua \
      -f markdown -t html "$file" -o "$temp_file" >/dev/null 2>&1

    html_content="$(cat "$temp_file")"
    rm -rf "$temp_file"

    echo "<entry>"
    echo "<title>$title</title>"
    echo "<link href='https://maw.sh/blog/$slug'/>"
    echo "<id>https://maw.sh/blog/$slug</id>"
    echo "<updated>$formatted_date</updated>"
    echo "<summary>$description</summary>"
    echo "<content type='html'><![CDATA["
    echo "$html_content"
    echo "]]></content>"
    echo "</entry>"
  done

  rm "$blogs"

  echo '</feed>'
}

main >"$atom_file"
echo "[atom feed generated]:" "$atom_file"
